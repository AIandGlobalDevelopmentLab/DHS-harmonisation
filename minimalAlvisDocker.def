bootstrap: docker
from: posit/r-base:4.4.1-jammy

%help
    Simple container with R base and minimal packages for running minimalAlvisRun.sh. There is a problem with this recipe because it doesn't load Lmod, which then results in an error somewhere in Hans's globallivingconditions package.

%post
    export DEBIAN_FRONTEND="noninteractive"
    apt-get update
    apt-get install -y gnupg

    #apt-get -y build-dep lmod
    #lua_ver=$(which lua | xargs realpath -e | xargs basename)
    #apt-get -y install lib${lua_ver}-dev tcl-dev
    apt-get install -y lua5.4 liblua5.4-dev lua-posix lua-posix-dev tcl tcl-dev libtcl lua-bit32 liblua5.4-0 tcl8.6 tcl8.6-dev libtcl8.6
    apt-get install -y texlive-xetex texlive-science git
    apt-get update

    apt-get install -y r-cran-devtools r-cran-knitr r-cran-xml r-cran-httr r-cran-data.table r-cran-foreach r-cran-hmisc r-cran-car r-cran-sp r-cran-rgdal r-cran-future  r-cran-xtable  r-cran-geosphere r-cran-deldir  r-cran-benchmarkme r-cran-reticulate r-cran-magick r-cran-snow  r-cran-rcurl r-cran-knitr r-cran-sp r-cran-rgdal

    apt-get install -y libpng-dev libjpeg-dev libcurl4-gnutls-dev libssl-dev libxml2-dev libgdal-dev libudunits2-dev libproj-dev cmake libfontconfig1-dev libharfbuzz-dev libfribidi-dev libtiff-dev libfreetype-dev libgeos-dev libmagick++-dev libcharls2 libsecret-1-dev

    ## knitr support for formating python code
    apt-get install -y highlight

    # Install R packages
    sed -i 's|# options(repos.*$|options(repos = c(CRAN="https://cloud.r-project.org/"))|' /usr/lib/R/library/base/R/Rprofile

    R --slave -e 'library("devtools"); install.packages(c("magrittr", "readr", "lubridate", "purrr")); install_bitbucket(repo = "hansekbrand/iwi", ref = "99e59a070b914d392faef34bc9e22028b3df03e7", upgrade = "always"); install_bitbucket(repo = "hansekbrand/DHSharmonisation", ref = "733e7c92127369f886608bd168840b9c6373768d", upgrade = "always")'

    # Make image writable with overlays
    chmod a+rwX -fR /boot /bin /sbin /lib /lib32 /lib64 /usr /etc /var /opt || :



